<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONOCULUS - AI Security Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; -webkit-font-smoothing: antialiased; }
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .alert-pulse { animation: alert-shadow 2s infinite; }
        @keyframes alert-shadow {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden" x-data="dashboard()" x-init="init()">

    <!-- Header -->
    <header class="fixed top-0 inset-x-0 z-50 glass px-6 py-4 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
            </div>
            <h1 class="text-xl font-black tracking-tighter uppercase text-slate-900 lg:text-2xl">MONOCULUS</h1>
            <div class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-slate-100/50 border border-slate-200">
                <div class="w-2 h-2 rounded-full animate-pulse" :class="connected ? 'bg-green-500' : 'bg-red-500'"></div>
                <span class="text-[10px] font-bold text-slate-500 tracking-wider transition-all" x-text="connected ? 'CONNECTED' : 'DISCONNECTED'"></span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button @click="resetStatus()" class="group p-2 rounded-full hover:bg-slate-100 transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 group-hover:rotate-180 transition-transform duration-500"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 shadow-md"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-2xl mx-auto pt-32 pb-24 px-6 space-y-8">

        <!-- Emergency Alert View (Overlay style) -->
        <template x-if="isAlert()">
            <div class="space-y-6">
                <div class="bg-red-600 text-white rounded-3xl p-8 shadow-2xl flex flex-col items-center text-center space-y-4 alert-pulse">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center animate-bounce">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black mb-1">EMERGENCY DETECTED</h2>
                        <p class="text-white/80 text-sm font-medium">Critical event requires immediate attention</p>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-xl border border-slate-100 relative group">
                    <div class="aspect-video bg-slate-900 relative overflow-hidden">
                        <img :src="getLatestImage()" class="w-full h-full object-cover transition-all duration-700" :class="state.fall.detected ? 'blur-2xl opacity-40' : 'opacity-90'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/20"></div>
                        
                        <div class="absolute top-6 left-6 flex gap-2">
                            <div class="bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1.5">
                                <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div> LIVE FEED
                            </div>
                            <div x-show="state.fall.detected" class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded">PRIVACY MASKING</div>
                        </div>

                        <div x-show="state.fall.detected" class="absolute inset-0 flex items-center justify-center text-center px-12">
                             <p class="text-white/60 text-xs font-medium tracking-wide leading-relaxed">NPU Ïò®ÎîîÎ∞îÏù¥Ïä§ Í∏∞Ïà†Î°ú<br>ÏÇ¨Ïö©ÏûêÏùò ÌîÑÎùºÏù¥Î≤ÑÏãúÎ•º Î≥¥Ìò∏ Ï§ëÏûÖÎãàÎã§.</p>
                        </div>
                    </div>

                    <div class="p-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <span class="bg-red-50 text-red-600 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-wider mb-2 inline-block">ALERT TYPE</span>
                                <h3 class="text-4xl font-black text-slate-900 tracking-tighter" x-text="getAlertTitle()">ÎÇôÏÉÅ Í∞êÏßÄ</h3>
                            </div>
                            <div class="text-right">
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">OCCURRED AT</p>
                                <p class="text-slate-900 font-black text-xl tabular-nums" x-text="getAlertTime()">12:45:01</p>
                            </div>
                        </div>

                        <div class="bg-slate-50 border border-slate-100 p-5 rounded-3xl mb-8">
                            <p class="text-slate-600 text-sm leading-relaxed" x-text="getAlertReason()"></p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button @click="triggerAlarm()" class="bg-slate-900 text-white py-5 rounded-[1.5rem] font-bold flex items-center justify-center gap-3 active:scale-95 transition-all hover:bg-black shadow-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                                <span>Í≤ΩÍ≥†Ïùå</span>
                            </button>
                            <button @click="emergencyCall()" class="bg-red-600 text-white py-5 rounded-[1.5rem] font-bold flex items-center justify-center gap-3 active:scale-95 transition-all hover:bg-red-700 shadow-xl shadow-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                <span>Í∏¥Í∏â Ìò∏Ï∂ú</span>
                            </button>
                        </div>

                        <button @click="resetStatus()" class="w-full mt-8 py-2 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] hover:text-blue-600 transition-colors">
                            CLEAR ALL ALERTS & SYSTEM RECOVERY
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Monitoring Status View -->
        <template x-if="!isAlert()">
            <div class="space-y-8">
                <!-- Main Status Card -->
                <div class="bg-white rounded-[3rem] p-10 shadow-sm border border-slate-100 text-center relative overflow-hidden group">
                    <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-50 rounded-full blur-3xl group-hover:bg-blue-100/50 transition-colors"></div>
                    <div class="relative z-10 flex flex-col items-center">
                        <div class="relative w-28 h-28 mb-8">
                            <div class="absolute inset-0 bg-blue-500 rounded-full animate-ping opacity-20"></div>
                            <div class="relative w-full h-full bg-blue-600 rounded-full flex items-center justify-center shadow-2xl shadow-blue-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            </div>
                        </div>
                        <h2 class="text-3xl font-black text-slate-900 tracking-tight" x-text="state.is_home ? 'HOME MONITORING' : 'AWAY MONITORING'">HOME MONITORING</h2>
                        <p class="text-slate-400 font-medium mt-2 max-w-[200px]" x-text="state.is_home ? 'User detected. Watching for falls and sleep quality.' : 'User away. Watching for fire and intruders.'"></p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-indigo-50 rounded-2xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                            </div>
                            <h3 class="font-bold text-slate-500 text-xs tracking-wider uppercase">Sleep Activity</h3>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <span class="text-4xl font-black text-slate-900 tabular-nums" x-text="state.sleep.toss_turn_count">0</span>
                            <span class="text-sm font-bold text-indigo-500 uppercase tracking-tighter">MOVES</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-orange-50 rounded-2xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
                            </div>
                            <h3 class="font-bold text-slate-500 text-xs tracking-wider uppercase">Environment</h3>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <span class="text-4xl font-black text-slate-900 tabular-nums" x-text="state.sleep.temperature.toFixed(1)">23.5</span>
                            <span class="text-sm font-bold text-orange-500 uppercase tracking-tighter">¬∞C</span>
                        </div>
                    </div>
                </div>

                <!-- DeepX NPU Activity Log -->
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 space-y-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            <h3 class="font-black text-slate-900 tracking-tight text-lg">System Logs</h3>
                        </div>
                        <span class="text-[10px] font-black bg-blue-50 text-blue-600 px-2 py-0.5 rounded" x-text="'FPS: ' + state.fps"></span>
                    </div>
                    
                    <div class="space-y-4">
                        <template x-for="log in logs" :key="log.id">
                            <div class="flex gap-4 items-start group">
                                <div class="w-1 h-8 rounded-full bg-blue-100 group-hover:bg-blue-500 transition-colors"></div>
                                <div class="flex-1">
                                    <p class="text-[11px] text-slate-400 font-bold uppercase tracking-widest tabular-nums" x-text="log.time">12:00:00</p>
                                    <p class="text-sm font-bold text-slate-700 leading-snug" x-text="log.message">Monitoring Service Started</p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 inset-x-0 p-6 glass border-t border-slate-200">
        <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-black text-slate-400 tracking-widest uppercase">
            <span>Powered by Monoculus AI</span>
            <div class="flex gap-4">
                <span class="text-blue-600">NPU ACTIVE</span>
                <span x-text="'UPTIME: ' + uptime"></span>
            </div>
        </div>
    </footer>

    <script>
        function dashboard() {
            return {
                connected: false,
                uptime: '00:00:00',
                startTime: Date.now(),
                state: {
                    is_home: true,
                    fps: 0,
                    fire: { detected: false },
                    intruder: { detected: false },
                    fall: { detected: false },
                    sleep: { toss_turn_count: 0, temperature: 23.5 }
                },
                logs: [],
                
                init() {
                    this.updateUptime();
                    setInterval(() => this.updateUptime(), 1000);
                    this.fetchData();
                    setInterval(() => this.fetchData(), 2000);
                    this.addLog("Monoculus Dashboard Initialized");
                },

                updateUptime() {
                    const diff = Math.floor((Date.now() - this.startTime) / 1000);
                    const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                    const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    this.uptime = `${h}:${m}:${s}`;
                },

                async fetchData() {
                    try {
                        const res = await fetch('/api/status');
                        if (res.ok) {
                            const data = await res.json();
                            const prev = JSON.stringify(this.state);
                            this.state = data;
                            this.connected = true;

                            // Check for new alerts to log
                            if (data.fire.detected && !JSON.parse(prev).fire.detected) this.addLog("üî• ALERT: Fire/Smoke detected!");
                            if (data.intruder.detected && !JSON.parse(prev).intruder.detected) this.addLog("üö® ALERT: Intruder detected!");
                            if (data.fall.detected && !JSON.parse(prev).fall.detected) this.addLog("‚ö° ALERT: Fall detected!");
                        } else {
                            this.connected = false;
                        }
                    } catch (e) {
                        this.connected = false;
                    }
                },

                isAlert() {
                    return this.state.fire.detected || this.state.intruder.detected || this.state.fall.detected;
                },

                getAlertTitle() {
                    if (this.state.fire.detected) return (this.state.fire.type || "Fire") + " Í∞êÏßÄ";
                    if (this.state.intruder.detected) return "Ïπ®ÏûÖÏûê ÌÉêÏßÄ";
                    if (this.state.fall.detected) return "ÎÇôÏÉÅ Î∞úÏÉù";
                    return "ÏúÑÍ∏â ÏÉÅÌô©";
                },

                getAlertTime() {
                    if (this.state.fire.detected) return this.state.fire.last_time || this.state.last_update;
                    if (this.state.intruder.detected) return this.state.intruder.last_time || this.state.last_update;
                    if (this.state.fall.detected) return this.state.fall.last_time || this.state.last_update;
                    return this.state.last_update;
                },

                getAlertReason() {
                    if (this.state.fire.detected) return `${this.state.fire.type}Í∞Ä ${this.state.fire.level} Îã®Í≥ÑÎ°ú Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§. Ï¶âÏãú ÌôïÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.`;
                    if (this.state.intruder.detected) return "ÌóàÍ∞ÄÎêòÏßÄ ÏïäÏùÄ Ïù∏ÏõêÏù¥ Î≥¥Ïïà Íµ¨Ïó≠ÏóêÏÑú Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§. ÏÇ¨Ïù¥Î†åÏù¥ ÏûëÎèô Ï§ëÏûÖÎãàÎã§.";
                    if (this.state.fall.detected) return "NPUÍ∞Ä Í∏âÍ≤©Ìïú Ï§ëÎ†• Í∞ÄÏÜçÎèÑ Î∞è Ïã†Ï≤¥ Í∞ÅÎèÑ Î≥ÄÌôîÎ•º Í∞êÏßÄÌñàÏäµÎãàÎã§. ÏùëÍ∏â ÏÉÅÌô©Ïùº Ïàò ÏûàÏäµÎãàÎã§.";
                    return "Ïïå Ïàò ÏóÜÎäî ÏúÑÍ∏â ÏÉÅÌô©Ïù¥ Î∞úÏÉùÌñàÏäµÎãàÎã§.";
                },

                getLatestImage() {
                    if (this.state.fire.detected) return this.state.fire.image_url || "/images/placeholder.jpg";
                    if (this.state.intruder.detected) return this.state.intruder.image_url || "/images/placeholder.jpg";
                    if (this.state.fall.detected) return this.state.fall.image_url || "/images/placeholder.jpg";
                    return "/images/placeholder.jpg";
                },

                addLog(msg) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('ko-KR', { hour12: false });
                    this.logs.unshift({ id: Date.now(), time, message: msg });
                    if (this.logs.length > 5) this.logs.pop();
                },

                async resetStatus() {
                    if (confirm("ÏÉÅÌô©ÏùÑ Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                        try {
                            const res = await fetch('/api/reset', { method: 'POST' });
                            if (res.ok) {
                                this.addLog("System Status Reset Manual");
                                this.fetchData();
                            }
                        } catch(e) {}
                    }
                },

                triggerAlarm() {
                    alert("üì¢ ÌòÑÏû•Ïóê Í∞ïÎ†•Ìïú Í≤ΩÍ≥†ÏùåÏù¥ ÏÜ°Ï∂úÎê©ÎãàÎã§!");
                    this.addLog("Manual Alarm Triggered");
                },

                emergencyCall() {
                    alert("üìû Í∏¥Í∏â Ïó∞ÎùΩÏ≤òÎ°ú ÌòÑÏû¨ ÏÉÅÌô©Í≥º ÏúÑÏπò Ï†ïÎ≥¥Í∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.");
                    this.addLog("Emergency Call Initiated");
                }
            }
        }
    </script>
</body>
</html>
