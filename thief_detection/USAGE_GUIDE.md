# 강도 침입 감지 시스템 사용 가이드

## 📋 목차
1. [시작하기 전에](#시작하기-전에)
2. [설치 방법](#설치-방법)
3. [설정 방법](#설정-방법)
4. [실행 방법](#실행-방법)
5. [문제 해결](#문제-해결)

---

## 🚀 시작하기 전에

### 필요한 것
- ✅ Python 3.8 이상
- ✅ 웹캠이 연결된 컴퓨터
- ✅ 네트워크에 연결된 환경
- ✅ Windows 관리자 권한 (ARP 스캔 시 필요)

---

## 📦 설치 방법

### 1. 가상환경 활성화 (이미 활성화되어 있다면 생략)
```powershell
.venv\Scripts\Activate.ps1
```

### 2. 필요한 패키지 설치
```powershell
cd thief_detection
pip install -r requirements.txt
```

설치되는 주요 패키지:
- `ultralytics`: YOLOv8 모델
- `opencv-python`: 카메라 처리
- `scapy`: ARP 스캔
- `torch`: 딥러닝 프레임워크

---

## ⚙️ 설정 방법

### 1. 네트워크 범위 확인

먼저 본인의 네트워크 정보를 확인합니다:

```powershell
ipconfig
```

출력 예시:
```
IPv4 주소 . . . . . . . . : 192.168.0.105
서브넷 마스크 . . . . . . : 255.255.255.0
```

위 정보를 바탕으로 `config.json`의 `network_range`를 설정합니다.
- IP가 192.168.0.x 형태면: `"192.168.0.0/24"`
- IP가 192.168.1.x 형태면: `"192.168.1.0/24"`
- IP가 10.0.0.x 형태면: `"10.0.0.0/24"`

### 2. 신뢰 장치 MAC 주소 확인

#### 방법 1: ARP 스캔으로 확인
```powershell
python main.py
# 모드 선택에서 '3' 입력 (ARP 스캔만 실행)
```

현재 네트워크의 모든 장치와 MAC 주소가 표시됩니다.

#### 방법 2: 직접 확인 (Windows)
본인의 PC:
```powershell
ipconfig /all
```

스마트폰 (Android):
1. 설정 → Wi-Fi → 연결된 네트워크 → 고급 → MAC 주소

스마트폰 (iOS):
1. 설정 → 일반 → 정보 → Wi-Fi 주소

### 3. config.json 수정

`thief_detection/config.json` 파일을 열어 수정합니다:

```json
{
  "trusted_devices": [
    "A0:B1:C2:D3:E4:F5",  ← 본인 스마트폰 MAC 주소
    "00:11:22:33:44:55"   ← 본인 노트북/PC MAC 주소
  ],
  "network_range": "192.168.0.0/24",  ← 본인 네트워크 범위
  "arp_timeout": 2,
  "yolo_model": "yolov8n.pt",
  "detection_threshold": 0.5,
  "alert_cooldown": 30,
  "camera_index": 0,
  "show_detection_window": true,
  "log_file": "intrusion_log.txt"
}
```

설정 항목 설명:
- `trusted_devices`: 신뢰할 장치들의 MAC 주소 목록 (집주인 기기)
- `network_range`: 스캔할 네트워크 범위
- `arp_timeout`: ARP 스캔 타임아웃 (초)
- `yolo_model`: 사용할 YOLO 모델 (yolov8n.pt가 가장 빠름)
- `detection_threshold`: 객체 인식 신뢰도 임계값 (0.0~1.0)
- `alert_cooldown`: 경보 간 최소 시간 간격 (초)
- `camera_index`: 카메라 번호 (0=기본 카메라)
- `show_detection_window`: 감지 화면 표시 여부
- `log_file`: 침입 로그 파일 이름

---

## 🎮 실행 방법

### 시스템 실행

**중요: ARP 스캔을 위해 관리자 권한으로 실행해야 합니다!**

PowerShell을 관리자 권한으로 실행 후:

```powershell
cd C:\Users\lota\Documents\SourceCodes\vscode\NPU_25_2\thief_detection
..\..\..\..\.venv\Scripts\Activate.ps1
python main.py
```

### 모드 선택

프로그램 실행 후 다음 중 하나를 선택:

#### 1️⃣ 단일 체크 모드
- 현재 시점에서 1회만 침입 여부 확인
- 테스트 용도로 적합

#### 2️⃣ 연속 모니터링 모드 ⭐ (권장)
- 주기적으로 침입 여부를 계속 확인
- 체크 간격(초)을 입력하면 그 주기로 반복
- 예: 30초마다 확인
- `Ctrl+C`로 중지

#### 3️⃣ ARP 스캔만 실행
- 네트워크의 모든 장치 확인
- MAC 주소 확인 용도

#### 4️⃣ 사람 감지만 실행
- 카메라 테스트 용도
- YOLOv8이 제대로 작동하는지 확인

---

## 🔍 동작 원리

```
1. ARP 스캔 시작
   ↓
2. 신뢰 장치(사용자 기기) 존재 확인
   ↓
   있음 → [안전] 종료
   ↓
   없음 → 3단계로
   ↓
3. 웹캠으로 사람 감지
   ↓
   없음 → [안전] 종료
   ↓
   있음 → [⚠️ 침입 감지!]
   ↓
4. 경보 발생 & 로그 기록
```

---

## 🧪 테스트 방법

### 1. 카메라 테스트
```powershell
python person_detector.py
```
웹캠이 켜지고 사람을 인식하는지 확인합니다.

### 2. ARP 스캔 테스트
```powershell
python arp_scanner.py
```
네트워크의 모든 장치가 나열됩니다.

### 3. 전체 시스템 테스트

**시나리오 1: 정상 상태 (사용자 재택)**
- 스마트폰 Wi-Fi 켜기
- `python main.py` → 모드 1 선택
- 결과: "안전: 사용자 기기가 네트워크에 존재합니다."

**시나리오 2: 침입 감지 (사용자 부재)**
- 스마트폰 Wi-Fi 끄기 또는 데이터로 전환
- 카메라 앞에 사람이 있는 상태
- `python main.py` → 모드 1 선택
- 결과: "⚠️ 경고: 침입자 감지!"

---

## ❗ 문제 해결

### Q1: "Import scapy could not be resolved" 오류
```powershell
pip install scapy
```

### Q2: "관리자 권한이 필요합니다" 오류
- PowerShell을 우클릭 → "관리자 권한으로 실행"
- 또는 VSCode를 관리자 권한으로 실행

### Q3: 카메라가 안 켜져요
```powershell
# config.json에서 camera_index를 변경해보세요
# 0 → 1, 또는 0 → 2
```

### Q4: YOLOv8 모델 다운로드가 느려요
- 처음 실행 시 모델을 자동 다운로드합니다 (약 6MB)
- 인터넷 연결을 확인하세요

### Q5: ARP 스캔에서 아무 장치도 안 나와요
- 네트워크 범위(`network_range`)를 확인하세요
- 방화벽 설정을 확인하세요
- 관리자 권한으로 실행했는지 확인하세요

### Q6: GPU를 사용하고 싶어요
```powershell
# PyTorch GPU 버전 설치
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

---

## 📊 실행 예시

```
====================================================================
강도 침입 감지 시스템
====================================================================

[Thief Detection] 설정 파일 로드 완료: config.json
[Person Detector] YOLOv8 모델 로딩 중: yolov8n.pt
[Person Detector] 사용 디바이스: cuda
[Thief Detection] 시스템 초기화 완료
[Thief Detection] 신뢰 장치 수: 2

모드를 선택하세요:
1. 단일 체크 모드 (1회만 확인)
2. 연속 모니터링 모드 (주기적으로 확인)
3. ARP 스캔만 실행 (네트워크 장치 확인)
4. 사람 감지만 실행 (카메라 테스트)

선택 (1-4): 2
체크 간격(초, 기본값 30): 20

====================================================================
연속 모니터링 모드 시작
체크 간격: 20초
종료하려면 Ctrl+C를 누르세요
====================================================================

--- 체크 #1 ---
====================================================================
[2025-11-17 10:30:00] 침입 감지 체크 시작
====================================================================

[1단계] ARP 스캔으로 사용자 기기 확인 중...
[ARP Scanner] 네트워크 스캔 시작: 192.168.0.0/24
[ARP Scanner] 스캔 완료: 8개 장치 발견
[ARP Scanner] 신뢰 장치 없음 (집에 아무도 없는 상태)

[2단계] 카메라로 사람 감지 중...
[Person Detector] 사람 감지! (신뢰도: 0.87)

**********************************************************************
[침입 감지] ⚠️ 경고: 침입자 감지! 사용자 부재 중 사람이 감지되었습니다!
**********************************************************************

🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨
🚨 침입 경보 🚨
시간: 2025-11-17 10:30:05
메시지: ⚠️ 경고: 침입자 감지! 사용자 부재 중 사람이 감지되었습니다!
🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨

[침입 감지] 로그 기록 완료: intrusion_log.txt

다음 체크까지 20초 대기 중...
(총 체크: 1회, 침입 감지: 1회)
```

---

## 🎯 다음 단계

현재 구현된 기능:
- ✅ ARP 스캔으로 사용자 기기 감지
- ✅ YOLOv8로 실시간 사람 감지
- ✅ 침입 판단 로직
- ✅ 콘솔 경보 및 로그 기록

향후 추가 가능한 기능:
- 📱 모바일 푸시 알림 (Telegram, Discord 등)
- 📹 침입 시 영상 녹화
- 📧 이메일 알림
- 🌐 웹 대시보드
- 🔊 사운드 경보
- ☁️ 클라우드 저장

---

## 📝 참고사항

- ARP 스캔은 같은 네트워크에서만 작동합니다
- VPN 사용 시 네트워크 범위가 달라질 수 있습니다
- 노트북/스마트폰의 MAC 주소는 Wi-Fi 설정에서 확인할 수 있습니다
- YOLOv8n 모델은 가볍지만 정확도가 높습니다
